<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>ç ”ç¿’æ—¥æ›†åŠ©æ‰‹ Mobile v3</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --cyan: #06b6d4;
            --cyan-glow: rgba(6, 182, 212, 0.3);
            --purple: #a855f7;
            --purple-glow: rgba(168, 85, 247, 0.3);
            --emerald: #10b981;
            --emerald-glow: rgba(16, 185, 129, 0.3);
            --orange: #f59e0b;
            --red: #ef4444;
            --gold: #fbbf24;
            --text-light: #e2e8f0;
            --text-dim: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --nav-height: 70px;
            --header-height: 60px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; touch-action: manipulation; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', Roboto, sans-serif; background: var(--bg-dark); color: var(--text-light); line-height: 1.5; }
        .app-container { height: 100%; display: flex; flex-direction: column; padding-top: env(safe-area-inset-top, 0px); padding-bottom: env(safe-area-inset-bottom, 0px); }
        .app-header { height: var(--header-height); background: linear-gradient(135deg, var(--cyan) 0%, var(--purple) 100%); display: flex; align-items: center; justify-content: space-between; padding: 0 16px; flex-shrink: 0; }
        .app-logo { display: flex; align-items: center; gap: 10px; font-size: 1.2em; font-weight: 700; }
        .header-actions { display: flex; gap: 8px; }
        .header-btn { width: 40px; height: 40px; border: none; background: rgba(255,255,255,0.2); border-radius: 12px; color: white; font-size: 1.3em; display: flex; align-items: center; justify-content: center; }
        .app-content { flex: 1; overflow: hidden; position: relative; }
        .page { position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow-y: auto; padding: 16px; padding-bottom: calc(var(--nav-height) + 20px); display: none; -webkit-overflow-scrolling: touch; }
        .page.active { display: block; }
        .bottom-nav { height: var(--nav-height); background: var(--bg-card); border-top: 1px solid var(--border); display: flex; flex-shrink: 0; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; border: none; background: transparent; color: var(--text-muted); padding: 8px 0; position: relative; }
        .nav-item::before { content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 0; height: 3px; background: var(--cyan); border-radius: 0 0 3px 3px; transition: width 0.3s; }
        .nav-item.active { color: var(--cyan); }
        .nav-item.active::before { width: 30px; }
        .nav-icon { font-size: 1.5em; }
        .nav-label { font-size: 0.75em; font-weight: 500; }
        .card { background: var(--bg-card); border-radius: 16px; padding: 20px; margin-bottom: 16px; border: 1px solid var(--border); }
        .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .card-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.4em; }
        .card-icon.cyan { background: var(--cyan-glow); }
        .card-icon.purple { background: var(--purple-glow); }
        .card-icon.emerald { background: var(--emerald-glow); }
        .card-title { font-size: 1.1em; font-weight: 600; }
        .card-subtitle { font-size: 0.85em; color: var(--text-dim); }
        .stats-row { display: flex; gap: 12px; margin-bottom: 20px; }
        .stat-card { flex: 1; background: var(--bg-card); border-radius: 14px; padding: 16px; text-align: center; border: 1px solid var(--border); }
        .stat-value { font-size: 1.8em; font-weight: 700; color: var(--cyan); }
        .stat-label { font-size: 0.8em; color: var(--text-muted); }
        .quick-actions { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px; }
        .quick-action { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 20px 16px; text-align: center; }
        .quick-action:active { transform: scale(0.98); background: var(--bg-card-hover); }
        .quick-action-icon { font-size: 2em; margin-bottom: 8px; }
        .quick-action-text { font-size: 0.9em; font-weight: 500; }
        .input-group { margin-bottom: 16px; }
        .input-label { display: block; font-size: 0.9em; font-weight: 500; color: var(--text-dim); margin-bottom: 8px; }
        .input-field { width: 100%; padding: 14px 16px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 12px; color: var(--text-light); font-size: 1em; -webkit-appearance: none; }
        .input-field:focus { outline: none; border-color: var(--cyan); }
        .input-field::placeholder { color: var(--text-muted); }
        textarea.input-field { min-height: 150px; resize: vertical; line-height: 1.6; }
        .input-row { display: flex; gap: 8px; }
        .input-row .input-field { flex: 1; }
        .input-btn { width: 50px; height: 50px; border: none; background: var(--bg-card-hover); border-radius: 12px; color: var(--text-dim); font-size: 1.2em; flex-shrink: 0; }
        .btn { width: 100%; padding: 16px 24px; border: none; border-radius: 14px; font-size: 1.05em; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, var(--cyan) 0%, var(--purple) 100%); color: white; }
        .btn-secondary { background: linear-gradient(135deg, var(--emerald) 0%, #059669 100%); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--cyan); color: var(--cyan); }
        .btn-danger { background: var(--red); color: white; }
        .btn-sm { padding: 12px 16px; font-size: 0.95em; }
        .action-row { display: flex; gap: 12px; margin-top: 16px; }
        .action-row .btn { flex: 1; }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; background: var(--bg-dark); padding: 6px; border-radius: 12px; }
        .tab { flex: 1; padding: 12px 8px; border: none; background: transparent; color: var(--text-muted); font-size: 0.9em; font-weight: 500; border-radius: 8px; }
        .tab.active { background: var(--cyan); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .upload-area { border: 2px dashed var(--border); border-radius: 16px; padding: 30px 20px; text-align: center; background: rgba(6, 182, 212, 0.05); display: block; cursor: pointer; }
        .upload-area:active { border-color: var(--cyan); background: rgba(6, 182, 212, 0.1); }
        .upload-icon { font-size: 3em; margin-bottom: 12px; }
        .upload-text { font-size: 1em; font-weight: 500; color: var(--cyan); }
        .upload-hint { font-size: 0.85em; color: var(--text-muted); margin-top: 8px; }
        .reminder-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .reminder-option { display: flex; align-items: center; gap: 10px; padding: 14px; background: var(--bg-dark); border: 2px solid var(--border); border-radius: 12px; }
        .reminder-option.checked { border-color: var(--cyan); background: var(--cyan-glow); }
        .reminder-option input { display: none; }
        .reminder-checkbox { width: 24px; height: 24px; border: 2px solid var(--border); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: transparent; }
        .reminder-option.checked .reminder-checkbox { background: var(--cyan); border-color: var(--cyan); color: white; }
        .reminder-label { font-size: 0.95em; }
        .event-list { margin-top: 20px; }
        .event-item { background: var(--bg-dark); border-radius: 14px; padding: 16px; margin-bottom: 12px; border-left: 4px solid var(--cyan); }
        .event-title { font-size: 1.05em; font-weight: 600; margin-bottom: 8px; }
        .event-meta { font-size: 0.9em; color: var(--text-dim); }
        .event-meta-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .day-badge { display: inline-block; background: linear-gradient(135deg, var(--cyan) 0%, var(--purple) 100%); color: white; padding: 2px 10px; border-radius: 6px; font-size: 0.8em; margin-left: 8px; }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
        .empty-icon { font-size: 3em; margin-bottom: 12px; opacity: 0.5; }
        .toast { position: fixed; bottom: calc(var(--nav-height) + 20px); left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-card); color: var(--text-light); padding: 14px 24px; border-radius: 12px; font-size: 0.95em; font-weight: 500; box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3); z-index: 1000; opacity: 0; transition: all 0.3s ease; max-width: calc(100% - 40px); text-align: center; border: 1px solid var(--border); }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { border-color: var(--emerald); background: rgba(16, 185, 129, 0.2); }
        .toast.error { border-color: var(--red); background: rgba(239, 68, 68, 0.2); }
        .toast.info { border-color: var(--cyan); background: rgba(6, 182, 212, 0.2); }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 1000; display: none; align-items: flex-end; }
        .modal-overlay.show { display: flex; }
        .modal-content { background: var(--bg-card); width: 100%; max-height: 85vh; border-radius: 24px 24px 0 0; overflow: hidden; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 1.2em; font-weight: 600; }
        .modal-close { width: 36px; height: 36px; border: none; background: var(--bg-dark); color: var(--text-dim); border-radius: 10px; font-size: 1.2em; }
        .modal-body { padding: 20px; max-height: calc(85vh - 80px); overflow-y: auto; }
        .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid var(--border); }
        .toggle-row:last-child { border-bottom: none; }
        .toggle-title { font-weight: 500; }
        .toggle-desc { font-size: 0.85em; color: var(--text-muted); }
        .toggle-switch { width: 52px; height: 30px; background: var(--border); border-radius: 15px; position: relative; transition: all 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; width: 24px; height: 24px; background: white; border-radius: 50%; top: 3px; left: 3px; transition: all 0.3s; }
        .toggle-switch.active { background: var(--cyan); }
        .toggle-switch.active::after { left: 25px; }
        .image-preview { width: 100%; max-height: 200px; object-fit: contain; border-radius: 12px; margin-top: 12px; display: none; }
        .image-preview.show { display: block; }
        .file-badge { display: inline-flex; align-items: center; gap: 8px; background: var(--emerald-glow); border: 1px solid var(--emerald); color: var(--emerald); padding: 8px 14px; border-radius: 10px; font-size: 0.9em; margin-top: 12px; }
        .schedule-item { background: var(--bg-dark); border-radius: 12px; padding: 14px; margin-bottom: 10px; border-left: 3px solid var(--emerald); }
        .schedule-title { font-weight: 600; margin-bottom: 6px; }
        .schedule-time { font-size: 0.85em; color: var(--text-dim); }
        .schedule-status { font-size: 0.8em; padding: 2px 8px; border-radius: 4px; margin-top: 6px; display: inline-block; }
        .schedule-status.pending { background: var(--orange); color: white; }
        .schedule-status.sent { background: var(--emerald); color: white; }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="app-logo"><span>ğŸ“…</span><span>ç ”ç¿’åŠ©æ‰‹ v3</span></div>
            <div class="header-actions">
                <button class="header-btn" id="helpBtn">â“</button>
                <button class="header-btn" id="settingsBtn">âš™ï¸</button>
            </div>
        </header>

        <main class="app-content">
            <!-- é¦–é  -->
            <div class="page active" id="page-home">
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-value" id="eventCount">0</div>
                        <div class="stat-label">å¾…åŒ¯å…¥äº‹ä»¶</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="scheduleCount">0</div>
                        <div class="stat-label">æ’ç¨‹æé†’</div>
                    </div>
                </div>
                <div class="quick-actions">
                    <div class="quick-action" id="qa-text"><div class="quick-action-icon">âœï¸</div><div class="quick-action-text">æ–‡å­—è¼¸å…¥</div></div>
                    <div class="quick-action" id="qa-file"><div class="quick-action-icon">ğŸ“„</div><div class="quick-action-text">ä¸Šå‚³æª”æ¡ˆ</div></div>
                    <div class="quick-action" id="qa-image"><div class="quick-action-icon">ğŸ“¸</div><div class="quick-action-text">æ‹ç…§è¾¨è­˜</div></div>
                    <div class="quick-action" id="qa-api"><div class="quick-action-icon">ğŸ”‘</div><div class="quick-action-text">API è¨­å®š</div></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon cyan">ğŸ“‹</div>
                        <div><div class="card-title">å¾…è™•ç†äº‹ä»¶</div><div class="card-subtitle">è§£æå®Œæˆå¾Œæœƒé¡¯ç¤ºåœ¨é€™è£¡</div></div>
                    </div>
                    <div id="homeEventList"><div class="empty-state"><div class="empty-icon">ğŸ“­</div><div>å°šç„¡å¾…è™•ç†äº‹ä»¶</div></div></div>
                </div>
            </div>

            <!-- è¼¸å…¥é  -->
            <div class="page" id="page-input">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon purple">ğŸ“</div>
                        <div><div class="card-title">è¼¸å…¥ç ”ç¿’è³‡è¨Š</div><div class="card-subtitle">é¸æ“‡è¼¸å…¥æ–¹å¼</div></div>
                    </div>
                    <div class="tabs">
                        <button class="tab active" id="tab-text">âœï¸ æ–‡å­—</button>
                        <button class="tab" id="tab-file">ğŸ“„ æª”æ¡ˆ</button>
                        <button class="tab" id="tab-image">ğŸ“¸ åœ–ç‰‡</button>
                    </div>
                    <div class="tab-content active" id="content-text">
                        <div class="input-group">
                            <label class="input-label">è²¼ä¸Šç ”ç¿’æ™‚ç¨‹è¡¨</label>
                            <textarea class="input-field" id="scheduleText" placeholder="ç¯„ä¾‹ï¼š
11/25ï¼ˆä¸€ï¼‰14:00-16:00
AI æ•™å­¸æ‡‰ç”¨å·¥ä½œåŠ
åœ°é»ï¼šç·šä¸Š Google Meet
è¬›å¸«ï¼šç‹è€å¸«"></textarea>
                        </div>
                    </div>
                    <div class="tab-content" id="content-file">
                        <label class="upload-area" for="fileUpload">
                            <input type="file" id="fileUpload" accept=".xlsx,.xls,.csv,.txt,.pdf" style="display:none;">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-text">é»æ“Šä¸Šå‚³æª”æ¡ˆ</div>
                            <div class="upload-hint">æ”¯æ´ Excelã€TXTã€CSVã€PDF</div>
                        </label>
                        <div id="fileInfo" style="display: none;"><div class="file-badge"><span>âœ…</span><span id="fileName">æª”æ¡ˆå·²è¼‰å…¥</span></div></div>
                    </div>
                    <div class="tab-content" id="content-image">
                        <label class="upload-area" for="imageUpload">
                            <input type="file" id="imageUpload" accept="image/*" style="display:none;">
                            <div class="upload-icon">ğŸ“·</div>
                            <div class="upload-text">é»æ“Šé¸æ“‡åœ–ç‰‡æˆ–æ‹ç…§</div>
                            <div class="upload-hint">æ”¯æ´ JPGã€PNGã€WEBP</div>
                        </label>
                        <img id="imagePreview" class="image-preview">
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon emerald">â°</div>
                        <div><div class="card-title">æé†’è¨­å®š</div><div class="card-subtitle">ICS æª”æ¡ˆæé†’æ™‚é–“</div></div>
                    </div>
                    <div class="reminder-grid" id="reminderGrid">
                        <label class="reminder-option" data-value="30"><input type="checkbox" value="30"><div class="reminder-checkbox">âœ“</div><span class="reminder-label">30 åˆ†é˜å‰</span></label>
                        <label class="reminder-option checked" data-value="60"><input type="checkbox" value="60" checked><div class="reminder-checkbox">âœ“</div><span class="reminder-label">1 å°æ™‚å‰</span></label>
                        <label class="reminder-option" data-value="120"><input type="checkbox" value="120"><div class="reminder-checkbox">âœ“</div><span class="reminder-label">2 å°æ™‚å‰</span></label>
                        <label class="reminder-option" data-value="1440"><input type="checkbox" value="1440"><div class="reminder-checkbox">âœ“</div><span class="reminder-label">1 å¤©å‰</span></label>
                    </div>
                </div>
                <button class="btn btn-primary" id="parseBtn"><span id="parseBtnText">ğŸš€ AI æ™ºèƒ½è§£æ</span><div class="spinner" id="parseSpinner"></div></button>
                <div id="eventsPreview" class="event-list" style="display: none;"></div>
                <div class="action-row" id="importActions" style="display: none;">
                    <button class="btn btn-secondary" id="importCalendarBtn">ğŸ”— åŒ¯å…¥æ—¥æ›†</button>
                    <button class="btn btn-outline" id="downloadIcsBtn">ğŸ“¥ ICS</button>
                    <button class="btn btn-outline" id="sendLineBtn">ğŸ“± LINE</button>
                </div>
            </div>

            <!-- LINE é  -->
            <div class="page" id="page-line">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon emerald">ğŸ””</div>
                        <div><div class="card-title">LINE æé†’æ’ç¨‹</div><div class="card-subtitle">è‡ªå‹•ç™¼é€ç ”ç¿’æé†’</div></div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label class="input-label">é¸æ“‡æé†’æ™‚é–“ï¼ˆç™¼é€ LINE æ™‚ä½¿ç”¨ï¼‰</label>
                        <div class="reminder-grid" id="lineReminderGrid">
                            <label class="reminder-option" data-value="1440"><input type="checkbox" id="reminder1Day" value="1440"><div class="reminder-checkbox">âœ“</div><span class="reminder-label">å‰ 1 å¤©</span></label>
                            <label class="reminder-option" data-value="120"><input type="checkbox" id="reminder2Hours" value="120"><div class="reminder-checkbox">âœ“</div><span class="reminder-label">å‰ 2 å°æ™‚</span></label>
                            <label class="reminder-option checked" data-value="60"><input type="checkbox" id="reminder1Hour" value="60" checked><div class="reminder-checkbox">âœ“</div><span class="reminder-label">å‰ 1 å°æ™‚</span></label>
                            <label class="reminder-option" data-value="30"><input type="checkbox" id="reminder30Min" value="30"><div class="reminder-checkbox">âœ“</div><span class="reminder-label">å‰ 30 åˆ†é˜</span></label>
                        </div>
                    </div>
                    <div class="action-row">
                        <button class="btn btn-outline btn-sm" id="viewSchedulesBtn">ğŸ“‹ æŸ¥çœ‹æ’ç¨‹</button>
                        <button class="btn btn-danger btn-sm" id="clearSchedulesBtn">ğŸ—‘ï¸ æ¸…é™¤æ’ç¨‹</button>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon cyan">ğŸ“Š</div>
                        <div><div class="card-title">è¨­å®šç‹€æ…‹</div><div class="card-subtitle">LINE é€šçŸ¥è¨­å®šæª¢æŸ¥</div></div>
                    </div>
                    <div id="lineStatusList">
                        <div class="toggle-row"><div><div class="toggle-title">Channel Token</div><div class="toggle-desc" id="tokenStatus">æœªè¨­å®š</div></div><span id="tokenIcon">âŒ</span></div>
                        <div class="toggle-row"><div><div class="toggle-title">User ID</div><div class="toggle-desc" id="userIdStatus">æœªè¨­å®š</div></div><span id="userIdIcon">âŒ</span></div>
                        <div class="toggle-row"><div><div class="toggle-title">GAS URL</div><div class="toggle-desc" id="gasStatus">æœªè¨­å®š</div></div><span id="gasIcon">âŒ</span></div>
                        <div class="toggle-row"><div><div class="toggle-title">Secret Key</div><div class="toggle-desc" id="secretStatus">æœªè¨­å®š</div></div><span id="secretIcon">âŒ</span></div>
                    </div>
                    <button class="btn btn-primary" id="goToSettingsBtn" style="margin-top: 16px;">âš™ï¸ å‰å¾€è¨­å®š</button>
                </div>
                <!-- æ’ç¨‹åˆ—è¡¨ -->
                <div class="card" id="scheduleListCard" style="display:none;">
                    <div class="card-header">
                        <div class="card-icon purple">ğŸ“…</div>
                        <div><div class="card-title">æ’ç¨‹ä¸­çš„æé†’</div><div class="card-subtitle" id="scheduleListCount">0 å€‹æ’ç¨‹</div></div>
                    </div>
                    <div id="scheduleList"></div>
                </div>
            </div>

            <!-- è¨­å®šé  -->
            <div class="page" id="page-settings">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon purple">ğŸ¤–</div>
                        <div><div class="card-title">Gemini API</div><div class="card-subtitle">AI æ™ºèƒ½è§£æï¼ˆé¸å¡«ï¼‰</div></div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">API Key</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="geminiApiKey" placeholder="é¸å¡«ï¼šå•Ÿç”¨ AI æ™ºèƒ½è§£æ">
                            <button class="input-btn" id="toggleGeminiKey">ğŸ‘ï¸</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon cyan">ğŸ”</div>
                        <div><div class="card-title">Google OAuth</div><div class="card-subtitle">è‡ªå‹•åŒ¯å…¥ Google æ—¥æ›†</div></div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Client ID</label>
                        <div class="input-row">
                            <input type="password" class="input-field" id="googleClientId" placeholder="è¼¸å…¥ Google OAuth Client ID">
                            <button class="input-btn" id="toggleGoogleId">ğŸ‘ï¸</button>
                        </div>
                    </div>
                    <button class="btn btn-outline btn-sm" id="authorizeBtn" style="margin-top:8px;">ğŸ” æˆæ¬Š Google æ—¥æ›†</button>
                    <div id="authStatus" style="margin-top:8px;font-size:0.85em;color:var(--text-dim);"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon emerald">ğŸ“±</div>
                        <div><div class="card-title">LINE é€šçŸ¥</div><div class="card-subtitle">ç ”ç¿’æé†’æ¨æ’­</div></div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Channel Access Token</label>
                        <div class="input-row"><input type="password" class="input-field" id="lineChannelAccessToken" placeholder="è¼¸å…¥ LINE Token"><button class="input-btn" id="toggleLineToken">ğŸ‘ï¸</button></div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">User ID</label>
                        <div class="input-row"><input type="password" class="input-field" id="lineUserId" placeholder="è¼¸å…¥ LINE User ID"><button class="input-btn" id="toggleLineUserId">ğŸ‘ï¸</button></div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">GAS Web App URL</label>
                        <div class="input-row"><input type="password" class="input-field" id="gasWebAppUrl" placeholder="è¼¸å…¥ GAS ç¶²å€"><button class="input-btn" id="toggleGasUrl">ğŸ‘ï¸</button></div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">ğŸ” Secret Key</label>
                        <div class="input-row"><input type="password" class="input-field" id="gasSecretKey" placeholder="è¼¸å…¥å®‰å…¨é‡‘é‘°"><button class="input-btn" id="toggleGasSecret">ğŸ‘ï¸</button></div>
                    </div>
                    <button class="btn btn-outline btn-sm" id="testLineBtn">ğŸ“¤ ç™¼é€æ¸¬è©¦è¨Šæ¯</button>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon cyan">ğŸ’¾</div>
                        <div><div class="card-title">æœ¬æ©Ÿå„²å­˜</div><div class="card-subtitle">è‡ªå‹•è¨˜ä½è¨­å®š</div></div>
                    </div>
                    <div class="toggle-row">
                        <div><div class="toggle-title">å•Ÿç”¨æœ¬æ©Ÿå„²å­˜</div><div class="toggle-desc">API é‡‘é‘°å°‡å„²å­˜åœ¨æœ¬æ©Ÿ</div></div>
                        <div class="toggle-switch" id="localStorageToggle"></div>
                    </div>
                </div>
                <button class="btn btn-danger" id="clearAllBtn" style="margin-top: 20px;">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" data-page="home"><span class="nav-icon">ğŸ </span><span class="nav-label">é¦–é </span></button>
            <button class="nav-item" data-page="input"><span class="nav-icon">ğŸ“</span><span class="nav-label">è¼¸å…¥</span></button>
            <button class="nav-item" data-page="line"><span class="nav-icon">ğŸ“±</span><span class="nav-label">LINE</span></button>
            <button class="nav-item" data-page="settings"><span class="nav-icon">âš™ï¸</span><span class="nav-label">è¨­å®š</span></button>
        </nav>
    </div>

    <div class="toast" id="toast"></div>

    <div class="modal-overlay" id="helpModal">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title">ğŸ“š å¹«åŠ©ä¸­å¿ƒ</div><button class="modal-close" id="closeHelpBtn">âœ•</button></div>
            <div class="modal-body">
                <div class="card" style="margin-bottom:12px;"><div class="card-title">ğŸš€ ä½¿ç”¨æµç¨‹</div><p style="margin-top:8px;color:var(--text-dim);font-size:0.9em;">1. è¼¸å…¥/ä¸Šå‚³ç ”ç¿’è³‡è¨Š<br>2. AI æ™ºèƒ½è§£æ<br>3. ä¸‹è¼‰ ICS æˆ–ç™¼é€ LINE<br>4. è‡ªå‹•å»ºç«‹æé†’æ’ç¨‹</p></div>
                <div class="card" style="margin-bottom:12px;"><div class="card-title">ğŸ”” LINE æ’ç¨‹æé†’</div><p style="margin-top:8px;color:var(--text-dim);font-size:0.9em;">è¨­å®š GAS + Google Sheets å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•åœ¨ç ”ç¿’å‰ç™¼é€ LINE æé†’ï¼ˆå‰1å¤©/2å°æ™‚/1å°æ™‚/30åˆ†é˜ï¼‰</p></div>
            </div>
        </div>
    </div>

    <script>
        var parsedEvents = [];
        var uploadedFilesContentArray = [];
        var uploadedImagesArray = [];
        var activeInputTab = 'text';
        var localStorageEnabled = false;
        var STORAGE_PREFIX = 'workshop_mobile_v3_';

        // Google OAuth è®Šæ•¸
        var tokenClient;
        var gapiInited = false;
        var gisInited = false;
        var DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'];
        var SCOPES = 'https://www.googleapis.com/auth/calendar.events';
        var TOKEN_KEY = STORAGE_PREFIX + 'google_token';
        
        // 24 å°æ™‚å¿«å–ç­–ç•¥å¸¸æ•¸
        var LOCAL_AUTH_VALID_HOURS = 24; // æœ¬åœ°èªè­‰æœ‰æ•ˆæœŸï¼ˆå°æ™‚ï¼‰
        var TOKEN_SOFT_EXPIRE = LOCAL_AUTH_VALID_HOURS * 60 * 60; // 24 å°æ™‚ï¼ˆç§’ï¼‰

        document.addEventListener('DOMContentLoaded', function() {
            initNavigation();
            initTabs();
            initButtons();
            initReminders();
            initUploads();
            initToggles();
            initModals();
            loadSettings();
            initGoogleAPI();
            console.log('âœ… App v3 åˆå§‹åŒ–å®Œæˆ');
        });

        // ========================================
        // Google OAuth åˆå§‹åŒ–ï¼ˆå« Token å¿«å–ï¼‰
        // ========================================
        function initGoogleAPI() {
            if (typeof gapi !== 'undefined') {
                gapi.load('client', async function() {
                    try {
                        await gapi.client.init({ discoveryDocs: DISCOVERY_DOCS });
                        gapiInited = true;
                        console.log('âœ… GAPI åˆå§‹åŒ–å®Œæˆ');
                        // å˜—è©¦è¼‰å…¥å·²å„²å­˜çš„ token
                        loadSavedToken();
                    } catch (err) { console.error('GAPI åˆå§‹åŒ–å¤±æ•—:', err); }
                });
            }
        }

        // å„²å­˜ Token åˆ° localStorageï¼ˆ24 å°æ™‚æœ‰æ•ˆæœŸç­–ç•¥ï¼‰
        function saveToken(token) {
            try {
                var tokenData = {
                    token: token,
                    savedAt: Date.now(),
                    expiresIn: TOKEN_SOFT_EXPIRE, // ä½¿ç”¨ 24 å°æ™‚ä½œç‚ºæœ¬åœ°æœ‰æ•ˆæœŸ
                    actualExpiresIn: token.expires_in || 3600 // è¨˜éŒ„ Google å¯¦éš›éæœŸæ™‚é–“
                };
                localStorage.setItem(TOKEN_KEY, JSON.stringify(tokenData));
                console.log('âœ… Token å·²å„²å­˜ï¼ˆ24 å°æ™‚æœ‰æ•ˆæœŸç­–ç•¥ï¼‰');
            } catch (e) { console.error('å„²å­˜ Token å¤±æ•—:', e); }
        }

        // è¼‰å…¥å·²å„²å­˜çš„ Tokenï¼ˆ24 å°æ™‚æœ‰æ•ˆæœŸç­–ç•¥ï¼‰
        function loadSavedToken() {
            try {
                var saved = localStorage.getItem(TOKEN_KEY);
                if (!saved) return false;
                
                var tokenData = JSON.parse(saved);
                var elapsed = (Date.now() - tokenData.savedAt) / 1000; // ç§’
                var expiresIn = tokenData.expiresIn || TOKEN_SOFT_EXPIRE;
                
                // æª¢æŸ¥ 24 å°æ™‚æœ¬åœ°æœ‰æ•ˆæœŸ
                if (elapsed < expiresIn - 300) {
                    gapi.client.setToken(tokenData.token);
                    gisInited = true;
                    var remaining = Math.floor((expiresIn - elapsed) / 3600);
                    var remainingMins = Math.floor(((expiresIn - elapsed) % 3600) / 60);
                    var timeStr = remaining > 0 ? remaining + ' å°æ™‚ ' + remainingMins + ' åˆ†é˜' : remainingMins + ' åˆ†é˜';
                    document.getElementById('authStatus').innerHTML = 'âœ… å·²æˆæ¬Šï¼ˆå‰©é¤˜ç´„ ' + timeStr + 'ï¼‰';
                    document.getElementById('authStatus').style.color = '#10b981';
                    console.log('âœ… å·²è¼‰å…¥å„²å­˜çš„ Tokenï¼Œå‰©é¤˜ç´„ ' + timeStr);
                    return true;
                } else {
                    // 24 å°æ™‚éæœŸï¼Œæ¸…é™¤
                    localStorage.removeItem(TOKEN_KEY);
                    console.log('âš ï¸ å„²å­˜çš„ Token å·²é 24 å°æ™‚');
                    return false;
                }
            } catch (e) { 
                console.error('è¼‰å…¥ Token å¤±æ•—:', e); 
                return false;
            }
        }

        // æª¢æŸ¥ Token æ˜¯å¦åœ¨ 24 å°æ™‚æœ¬åœ°æœ‰æ•ˆæœŸå…§
        function isTokenValid() {
            var token = gapi.client.getToken();
            if (!token) return false;
            
            try {
                var saved = localStorage.getItem(TOKEN_KEY);
                if (!saved) return !!token;
                
                var tokenData = JSON.parse(saved);
                var elapsed = (Date.now() - tokenData.savedAt) / 1000;
                var expiresIn = tokenData.expiresIn || TOKEN_SOFT_EXPIRE;
                
                return elapsed < expiresIn - 60; // é ç•™ 1 åˆ†é˜ç·©è¡
            } catch (e) { return !!token; }
        }
        
        // æª¢æŸ¥ Google å¯¦éš› Token æ˜¯å¦éæœŸï¼ˆç”¨æ–¼è‡ªå‹•éœé»˜åˆ·æ–°ï¼‰
        function isGoogleTokenExpired() {
            try {
                var saved = localStorage.getItem(TOKEN_KEY);
                if (!saved) return true;
                
                var tokenData = JSON.parse(saved);
                var elapsed = (Date.now() - tokenData.savedAt) / 1000;
                var actualExpiresIn = tokenData.actualExpiresIn || 3600;
                
                return elapsed >= actualExpiresIn - 60; // Google token éæœŸ
            } catch (e) { return true; }
        }

        function initTokenClient() {
            var clientId = document.getElementById('googleClientId').value.trim();
            if (!clientId) { showToast('âš ï¸ è«‹å…ˆè¼¸å…¥ Google Client ID', 'error'); return false; }
            if (typeof google === 'undefined' || !google.accounts) { showToast('âš ï¸ Google API å°šæœªè¼‰å…¥', 'error'); return false; }
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: SCOPES,
                callback: function(response) {
                    if (response.error) {
                        showToast('âŒ æˆæ¬Šå¤±æ•—: ' + response.error, 'error');
                        return;
                    }
                    gisInited = true;
                    // å„²å­˜ Tokenï¼ˆä½¿ç”¨ 24 å°æ™‚æœ‰æ•ˆæœŸç­–ç•¥ï¼‰
                    saveToken(response);
                    document.getElementById('authStatus').innerHTML = 'âœ… å·²æˆæ¬Šï¼ˆ24 å°æ™‚æœ‰æ•ˆï¼‰';
                    document.getElementById('authStatus').style.color = '#10b981';
                    showToast('âœ… Google æ—¥æ›†æˆæ¬ŠæˆåŠŸï¼', 'success');
                }
            });
            return true;
        }

        function handleAuthorize() {
            // å…ˆæª¢æŸ¥æ˜¯å¦åœ¨ 24 å°æ™‚æœ¬åœ°æœ‰æ•ˆæœŸå…§
            if (isTokenValid()) {
                showToast('âœ… æˆæ¬Šä»ç„¶æœ‰æ•ˆï¼ˆ24 å°æ™‚å…§ï¼‰ï¼Œç„¡éœ€é‡æ–°æˆæ¬Š', 'success');
                return;
            }
            
            if (!initTokenClient()) return;
            // ä½¿ç”¨ prompt: '' å¯ä»¥éœé»˜æˆæ¬Šï¼ˆå¦‚æœä¹‹å‰å·²æˆæ¬Šéï¼‰
            tokenClient.requestAccessToken({ prompt: '' });
        }

        async function addToGoogleCalendar() {
            if (parsedEvents.length === 0) { showToast('âŒ æ²’æœ‰å¯åŒ¯å…¥çš„äº‹ä»¶', 'error'); return; }
            var clientId = document.getElementById('googleClientId').value.trim();
            if (!clientId) { showToast('âš ï¸ è«‹å…ˆè¨­å®š Google Client ID', 'error'); switchToPage('settings'); return; }
            
            // æª¢æŸ¥æ˜¯å¦åœ¨ 24 å°æ™‚æœ¬åœ°æœ‰æ•ˆæœŸå…§
            if (isTokenValid()) {
                // æª¢æŸ¥ Google å¯¦éš› token æ˜¯å¦éæœŸï¼Œéœ€è¦éœé»˜åˆ·æ–°
                if (isGoogleTokenExpired()) {
                    console.log('ğŸ”„ Google token å·²éæœŸï¼Œå˜—è©¦éœé»˜åˆ·æ–°...');
                    await silentRefreshAndExecute(doAddEvents);
                } else {
                    doAddEvents();
                }
                return;
            }
            
            // éœ€è¦é‡æ–°æˆæ¬Š
            if (!initTokenClient()) return;
            
            tokenClient.requestAccessToken({
                prompt: '', // éœé»˜æˆæ¬Š
                callback: function(response) {
                    if (!response.error) {
                        saveToken(response);
                        doAddEvents();
                    }
                }
            });
        }
        
        // éœé»˜åˆ·æ–° Token ä¸¦åŸ·è¡Œå›èª¿
        async function silentRefreshAndExecute(callback) {
            return new Promise(function(resolve) {
                if (!initTokenClient()) {
                    resolve(false);
                    return;
                }
                
                tokenClient.requestAccessToken({
                    prompt: '', // éœé»˜æˆæ¬Šï¼ˆç”¨æˆ¶å·²æˆæ¬Šéçš„æƒ…æ³ä¸‹ç„¡éœ€äº’å‹•ï¼‰
                    callback: function(response) {
                        if (response.error) {
                            console.log('âš ï¸ éœé»˜åˆ·æ–°å¤±æ•—ï¼Œå¯èƒ½éœ€è¦é‡æ–°æˆæ¬Š');
                            // éœé»˜åˆ·æ–°å¤±æ•—ï¼Œå˜—è©¦æ­£å¸¸æˆæ¬Š
                            tokenClient.requestAccessToken({ prompt: 'consent' });
                        } else {
                            console.log('âœ… Token å·²éœé»˜åˆ·æ–°');
                            saveToken(response);
                            if (callback) callback();
                        }
                        resolve(!response.error);
                    }
                });
            });
        }

        async function doAddEvents() {
            showToast('ğŸ”„ æ­£åœ¨åŒ¯å…¥æ—¥æ›†...', 'info');
            var reminders = [];
            document.querySelectorAll('#reminderGrid .reminder-option.checked input').forEach(function(i) { reminders.push(parseInt(i.value)); });
            var successCount = 0;
            var retryNeeded = false;
            
            for (var i = 0; i < parsedEvents.length; i++) {
                var e = parsedEvents[i];
                var calendarEvent = {
                    summary: e.title || 'æœªå‘½åç ”ç¿’',
                    location: e.location || '',
                    description: e.description || '',
                    start: { dateTime: e.startDateTime, timeZone: 'Asia/Taipei' },
                    end: { dateTime: e.endDateTime, timeZone: 'Asia/Taipei' },
                    reminders: {
                        useDefault: false,
                        overrides: reminders.map(function(m) { return { method: 'popup', minutes: m }; })
                    }
                };
                try {
                    await gapi.client.calendar.events.insert({ calendarId: 'primary', resource: calendarEvent });
                    successCount++;
                } catch (err) {
                    console.error('åŒ¯å…¥å¤±æ•—:', err);
                    // æª¢æŸ¥æ˜¯å¦æ˜¯æˆæ¬ŠéŒ¯èª¤ï¼ˆ401ï¼‰
                    if (err.status === 401 || (err.result && err.result.error && err.result.error.code === 401)) {
                        retryNeeded = true;
                        break;
                    }
                }
            }
            
            // å¦‚æœé‡åˆ°æˆæ¬ŠéŒ¯èª¤ï¼Œå˜—è©¦éœé»˜åˆ·æ–°å¾Œé‡è©¦
            if (retryNeeded) {
                console.log('ğŸ”„ åµæ¸¬åˆ°æˆæ¬Šå¤±æ•ˆï¼Œå˜—è©¦éœé»˜åˆ·æ–°...');
                showToast('ğŸ”„ æ­£åœ¨åˆ·æ–°æˆæ¬Š...', 'info');
                var refreshed = await silentRefreshAndExecute(null);
                if (refreshed) {
                    // é‡æ–°åŸ·è¡ŒåŒ¯å…¥
                    doAddEvents();
                } else {
                    showToast('âŒ æˆæ¬Šå¤±æ•ˆï¼Œè«‹é‡æ–°æˆæ¬Š', 'error');
                }
                return;
            }
            
            showToast('âœ… æˆåŠŸåŒ¯å…¥ ' + successCount + ' å€‹äº‹ä»¶ï¼', 'success');
        }

        function initNavigation() {
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    switchToPage(this.getAttribute('data-page'));
                });
            });
        }

        function switchToPage(pageName) {
            document.querySelectorAll('.page').forEach(function(page) { page.classList.remove('active'); });
            document.getElementById('page-' + pageName).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(function(item) {
                item.classList.remove('active');
                if (item.getAttribute('data-page') === pageName) item.classList.add('active');
            });
            if (pageName === 'line') { updateLineStatus(); loadScheduleList(); }
        }

        function initTabs() {
            document.querySelectorAll('.tabs .tab').forEach(function(tab) {
                tab.addEventListener('click', function() { switchInputTab(this.id.replace('tab-', '')); });
            });
        }

        function switchInputTab(tabName) {
            activeInputTab = tabName;
            document.querySelectorAll('.tabs .tab').forEach(function(tab) { tab.classList.remove('active'); });
            document.getElementById('tab-' + tabName).classList.add('active');
            document.querySelectorAll('.tab-content').forEach(function(content) { content.classList.remove('active'); });
            document.getElementById('content-' + tabName).classList.add('active');
        }

        function initButtons() {
            document.getElementById('qa-text').addEventListener('click', function() { switchToPage('input'); switchInputTab('text'); });
            document.getElementById('qa-file').addEventListener('click', function() { switchToPage('input'); switchInputTab('file'); });
            document.getElementById('qa-image').addEventListener('click', function() { switchToPage('input'); switchInputTab('image'); });
            document.getElementById('qa-api').addEventListener('click', function() { switchToPage('settings'); });
            document.getElementById('helpBtn').addEventListener('click', function() { document.getElementById('helpModal').classList.add('show'); });
            document.getElementById('settingsBtn').addEventListener('click', function() { switchToPage('settings'); });
            document.getElementById('parseBtn').addEventListener('click', parseSchedule);
            document.getElementById('importCalendarBtn').addEventListener('click', addToGoogleCalendar);
            document.getElementById('downloadIcsBtn').addEventListener('click', downloadICS);
            document.getElementById('sendLineBtn').addEventListener('click', sendToLineWithSchedule);
            document.getElementById('viewSchedulesBtn').addEventListener('click', loadScheduleList);
            document.getElementById('clearSchedulesBtn').addEventListener('click', clearAllReminders);
            document.getElementById('goToSettingsBtn').addEventListener('click', function() { switchToPage('settings'); });
            document.getElementById('testLineBtn').addEventListener('click', testLineNotification);
            document.getElementById('clearAllBtn').addEventListener('click', clearAllData);
            document.getElementById('authorizeBtn').addEventListener('click', handleAuthorize);
            document.getElementById('toggleGeminiKey').addEventListener('click', function() { toggleVisibility('geminiApiKey'); });
            document.getElementById('toggleGoogleId').addEventListener('click', function() { toggleVisibility('googleClientId'); });
            document.getElementById('toggleLineToken').addEventListener('click', function() { toggleVisibility('lineChannelAccessToken'); });
            document.getElementById('toggleLineUserId').addEventListener('click', function() { toggleVisibility('lineUserId'); });
            document.getElementById('toggleGasUrl').addEventListener('click', function() { toggleVisibility('gasWebAppUrl'); });
            document.getElementById('toggleGasSecret').addEventListener('click', function() { toggleVisibility('gasSecretKey'); });
        }

        function initReminders() {
            document.querySelectorAll('.reminder-option').forEach(function(option) {
                option.addEventListener('click', function() {
                    var checkbox = this.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    this.classList.toggle('checked', checkbox.checked);
                });
            });
        }

        function initUploads() {
            document.getElementById('fileUpload').addEventListener('change', handleFileUpload);
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
        }

        function initToggles() {
            document.getElementById('localStorageToggle').addEventListener('click', toggleLocalStorage);
        }

        function initModals() {
            document.getElementById('closeHelpBtn').addEventListener('click', function() { document.getElementById('helpModal').classList.remove('show'); });
            document.getElementById('helpModal').addEventListener('click', function(e) { if (e.target === this) this.classList.remove('show'); });
        }

        function showToast(message, type) {
            var toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + (type || '');
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 3000);
        }

        function toggleVisibility(inputId) {
            var input = document.getElementById(inputId);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function handleFileUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            showToast('ğŸ“„ æ­£åœ¨è®€å–æª”æ¡ˆ...', 'info');
            var reader = new FileReader();
            if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                reader.onload = function(e) {
                    try {
                        var workbook = XLSX.read(e.target.result, { type: 'binary' });
                        var content = '';
                        workbook.SheetNames.forEach(function(name) { content += XLSX.utils.sheet_to_csv(workbook.Sheets[name]) + '\n'; });
                        uploadedFilesContentArray.push({ name: file.name, content: content });
                        document.getElementById('fileInfo').style.display = 'block';
                        document.getElementById('fileName').textContent = file.name;
                        showToast('âœ… æª”æ¡ˆå·²è¼‰å…¥', 'success');
                    } catch (err) { showToast('âŒ è®€å–å¤±æ•—', 'error'); }
                };
                reader.readAsBinaryString(file);
            } else {
                reader.onload = function(e) {
                    uploadedFilesContentArray.push({ name: file.name, content: e.target.result });
                    document.getElementById('fileInfo').style.display = 'block';
                    document.getElementById('fileName').textContent = file.name;
                    showToast('âœ… æª”æ¡ˆå·²è¼‰å…¥', 'success');
                };
                reader.readAsText(file);
            }
        }

        function handleImageUpload(event) {
            var file = event.target.files[0];
            if (!file) return;
            showToast('ğŸ“¸ æ­£åœ¨è®€å–åœ–ç‰‡...', 'info');
            var reader = new FileReader();
            reader.onload = function(e) {
                uploadedImagesArray.push(e.target.result.split(',')[1]);
                var preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.classList.add('show');
                showToast('âœ… åœ–ç‰‡å·²è¼‰å…¥', 'success');
            };
            reader.readAsDataURL(file);
        }

        function parseSchedule() {
            var apiKey = document.getElementById('geminiApiKey').value.trim();
            var scheduleText = document.getElementById('scheduleText').value.trim();
            if (activeInputTab === 'text' && !scheduleText) { showToast('âš ï¸ è«‹è¼¸å…¥ç ”ç¿’è³‡è¨Š', 'error'); return; }
            if (activeInputTab === 'file' && uploadedFilesContentArray.length === 0) { showToast('âš ï¸ è«‹ä¸Šå‚³æª”æ¡ˆ', 'error'); return; }
            if (activeInputTab === 'image' && uploadedImagesArray.length === 0) { showToast('âš ï¸ è«‹ä¸Šå‚³åœ–ç‰‡', 'error'); return; }
            document.getElementById('parseBtnText').style.display = 'none';
            document.getElementById('parseSpinner').style.display = 'block';
            showToast('ğŸ”„ æ­£åœ¨è§£æä¸­...', 'info');
            setTimeout(function() {
                if (apiKey) { parseWithGemini(apiKey, scheduleText); }
                else { handleParseResult(parseWithBuiltIn(scheduleText)); }
            }, 300);
        }

        function handleParseResult(events) {
            document.getElementById('parseBtnText').style.display = 'inline';
            document.getElementById('parseSpinner').style.display = 'none';
            if (events && events.length > 0) {
                parsedEvents = events;
                displayEvents(events);
                document.getElementById('eventsPreview').style.display = 'block';
                document.getElementById('importActions').style.display = 'flex';
                document.getElementById('eventCount').textContent = events.length;
                showToast('âœ… è§£ææˆåŠŸï¼æ‰¾åˆ° ' + events.length + ' å€‹äº‹ä»¶', 'success');
            } else { showToast('âš ï¸ æœªæ‰¾åˆ°æœ‰æ•ˆäº‹ä»¶', 'error'); }
        }

        function parseWithGemini(apiKey, scheduleText) {
            var now = new Date();
            var prompt = 'ä½ æ˜¯æ™‚ç¨‹è¡¨è§£æåŠ©æ‰‹ã€‚ä»Šå¤©æ˜¯ ' + now.getFullYear() + 'å¹´' + (now.getMonth()+1) + 'æœˆ' + now.getDate() + 'æ—¥ã€‚\nè«‹å°‡ç ”ç¿’è³‡è¨Šè§£æç‚ºç´” JSON æ ¼å¼ï¼ˆä¸è¦ markdownï¼‰ï¼š\n{"events":[{"title":"æ¨™é¡Œ","startDateTime":"YYYY-MM-DDTHH:MM:SS","endDateTime":"YYYY-MM-DDTHH:MM:SS","location":"åœ°é»","description":"æè¿°"}]}\nè¦å‰‡ï¼šæ—¥æœŸç”¨ ISO 8601ï¼Œæ²’çµæŸæ™‚é–“é è¨­3å°æ™‚ï¼Œåªæœ‰æ—¥æœŸé è¨­09:00-12:00ã€‚\n\n';
            var content = activeInputTab === 'text' ? scheduleText : uploadedFilesContentArray.map(function(f) { return f.content; }).join('\n\n');
            var requestBody;
            if (activeInputTab === 'image' && uploadedImagesArray.length > 0) {
                var parts = [{ text: prompt + 'è«‹è¾¨è­˜åœ–ç‰‡ä¸­çš„ç ”ç¿’è³‡è¨Šï¼š' }];
                uploadedImagesArray.forEach(function(img) { parts.push({ inline_data: { mime_type: 'image/jpeg', data: img } }); });
                requestBody = { contents: [{ parts: parts }], generationConfig: { temperature: 0.2 } };
            } else {
                requestBody = { contents: [{ parts: [{ text: prompt + 'æ™‚ç¨‹è¡¨ï¼š\n' + content }] }], generationConfig: { temperature: 0.2 } };
            }
            fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey, {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(requestBody)
            }).then(function(r) { return r.json(); }).then(function(data) {
                if (data.error) throw new Error(data.error.message);
                var text = data.candidates[0].content.parts[0].text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                handleParseResult(JSON.parse(text).events || []);
            }).catch(function(err) { showToast('âŒ AI è§£æå¤±æ•—ï¼Œæ”¹ç”¨å…§å»º', 'error'); handleParseResult(parseWithBuiltIn(scheduleText)); });
        }

        function parseWithBuiltIn(text) {
            if (!text) return [];
            var events = [], lines = text.split('\n'), currentEvent = null, now = new Date();
            var dateTimeRegex = /(\d{1,2})[\/\-](\d{1,2}).*?(\d{1,2}):(\d{2})\s*[-~è‡³åˆ°]\s*(\d{1,2}):(\d{2})/;
            lines.forEach(function(line) {
                line = line.trim();
                if (!line) return;
                var m = line.match(dateTimeRegex);
                if (m) {
                    if (currentEvent && currentEvent.title) events.push(currentEvent);
                    var y = now.getFullYear(), mo = parseInt(m[1]), d = parseInt(m[2]);
                    currentEvent = {
                        title: '', location: '', description: '',
                        startDateTime: y + '-' + String(mo).padStart(2,'0') + '-' + String(d).padStart(2,'0') + 'T' + String(parseInt(m[3])).padStart(2,'0') + ':' + m[4] + ':00',
                        endDateTime: y + '-' + String(mo).padStart(2,'0') + '-' + String(d).padStart(2,'0') + 'T' + String(parseInt(m[5])).padStart(2,'0') + ':' + m[6] + ':00'
                    };
                } else if (currentEvent) {
                    if (line.includes('åœ°é»') || line.includes('Location')) currentEvent.location = line.replace(/åœ°é»[:ï¼š]?\s*/, '');
                    else if (!currentEvent.title && line.length > 2) currentEvent.title = line;
                    else currentEvent.description += line + '\n';
                }
            });
            if (currentEvent && currentEvent.title) events.push(currentEvent);
            return events;
        }

        function displayEvents(events) {
            var html = '', weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
            events.forEach(function(e, i) {
                var s = new Date(e.startDateTime), end = new Date(e.endDateTime);
                html += '<div class="event-item" id="event_' + i + '"><div class="event-title">' + (e.title || 'æœªå‘½å') + '</div>';
                html += '<div class="event-meta"><div class="event-meta-item">ğŸ“… ' + formatDate(s) + '<span class="day-badge">é€±' + weekdays[s.getDay()] + '</span></div>';
                html += '<div class="event-meta-item">â° ' + formatTime(s) + ' - ' + formatTime(end) + '</div>';
                if (e.location) html += '<div class="event-meta-item">ğŸ“ ' + e.location + '</div>';
                html += '</div></div>';
            });
            document.getElementById('eventsPreview').innerHTML = html;
            document.getElementById('homeEventList').innerHTML = html || '<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div>å°šç„¡å¾…è™•ç†äº‹ä»¶</div></div>';
        }

        function formatDate(d) { return d.getFullYear() + '/' + String(d.getMonth()+1).padStart(2,'0') + '/' + String(d.getDate()).padStart(2,'0'); }
        function formatTime(d) { return String(d.getHours()).padStart(2,'0') + ':' + String(d.getMinutes()).padStart(2,'0'); }

        function downloadICS() {
            if (parsedEvents.length === 0) { showToast('âŒ æ²’æœ‰äº‹ä»¶', 'error'); return; }
            var reminders = [];
            document.querySelectorAll('#reminderGrid .reminder-option.checked input').forEach(function(i) { reminders.push(parseInt(i.value)); });
            var ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Workshop Mobile v3//EN\nCALSCALE:GREGORIAN\n';
            parsedEvents.forEach(function(e, i) {
                var s = new Date(e.startDateTime), end = new Date(e.endDateTime), now = new Date();
                ics += 'BEGIN:VEVENT\nUID:workshop-' + i + '-' + Date.now() + '@mobile\nDTSTAMP:' + formatICS(now) + '\nDTSTART:' + formatICS(s) + '\nDTEND:' + formatICS(end) + '\nSUMMARY:' + escICS(e.title) + '\n';
                if (e.location) ics += 'LOCATION:' + escICS(e.location) + '\n';
                if (e.description) ics += 'DESCRIPTION:' + escICS(e.description) + '\n';
                reminders.forEach(function(m) { ics += 'BEGIN:VALARM\nTRIGGER:-PT' + m + 'M\nACTION:DISPLAY\nDESCRIPTION:ç ”ç¿’æé†’\nEND:VALARM\n'; });
                ics += 'END:VEVENT\n';
            });
            ics += 'END:VCALENDAR';
            var blob = new Blob([ics], { type: 'text/calendar;charset=utf-8' });
            var link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'ç ”ç¿’è¡Œäº‹æ›†_' + formatDate(new Date()).replace(/\//g, '') + '.ics';
            link.click();
            showToast('âœ… ICS å·²ä¸‹è¼‰', 'success');
        }

        function formatICS(d) { return d.getFullYear() + String(d.getMonth()+1).padStart(2,'0') + String(d.getDate()).padStart(2,'0') + 'T' + String(d.getHours()).padStart(2,'0') + String(d.getMinutes()).padStart(2,'0') + String(d.getSeconds()).padStart(2,'0'); }
        function escICS(t) { return t ? t.replace(/\\/g,'\\\\').replace(/;/g,'\\;').replace(/,/g,'\\,').replace(/\n/g,'\\n') : ''; }

        // ========================================
        // LINE æ’ç¨‹åŠŸèƒ½ï¼ˆå®Œæ•´ç‰ˆï¼‰
        // ========================================
        function getLineReminderMinutes() {
            var mins = [];
            if (document.getElementById('reminder1Day').checked) mins.push(1440);
            if (document.getElementById('reminder2Hours').checked) mins.push(120);
            if (document.getElementById('reminder1Hour').checked) mins.push(60);
            if (document.getElementById('reminder30Min').checked) mins.push(30);
            return mins;
        }

        function sendToLineWithSchedule() {
            if (parsedEvents.length === 0) { showToast('âŒ æ²’æœ‰äº‹ä»¶', 'error'); return; }
            var token = document.getElementById('lineChannelAccessToken').value.trim();
            var userId = document.getElementById('lineUserId').value.trim();
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();
            if (!token || !userId || !gasUrl || !gasSecret) { showToast('âš ï¸ è«‹å…ˆè¨­å®š LINE ç›¸é—œè³‡è¨Š', 'error'); return; }
            showToast('ğŸ“¤ æ­£åœ¨ç™¼é€ä¸¦å»ºç«‹æ’ç¨‹...', 'info');
            var reminderMinutes = getLineReminderMinutes();
            var workshopData = parsedEvents.map(function(e) {
                return { title: e.title || 'æœªå‘½å', startDateTime: e.startDateTime, endDateTime: e.endDateTime, location: e.location || '', description: e.description || '' };
            });
            // ç™¼é€ç ”ç¿’é€šçŸ¥
            fetch(gasUrl, {
                method: 'POST', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ secret: gasSecret, token: token, userId: userId, workshops: workshopData })
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.success) {
                    showToast('âœ… ç ”ç¿’é€šçŸ¥å·²ç™¼é€ï¼', 'success');
                    // å»ºç«‹æ’ç¨‹æé†’
                    if (reminderMinutes.length > 0) {
                        createReminderSchedules(workshopData, reminderMinutes, token, userId, gasUrl, gasSecret);
                    }
                } else { showToast('âŒ ç™¼é€å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥'), 'error'); }
            }).catch(function(err) { showToast('âŒ ç™¼é€å¤±æ•—ï¼š' + err.message, 'error'); });
        }

        function createReminderSchedules(workshops, reminderMinutes, token, userId, gasUrl, gasSecret) {
            var schedules = [];
            workshops.forEach(function(w) {
                var startTime = new Date(w.startDateTime);
                reminderMinutes.forEach(function(mins) {
                    var reminderTime = new Date(startTime.getTime() - mins * 60 * 1000);
                    if (reminderTime > new Date()) {
                        schedules.push({
                            workshopTitle: w.title,
                            workshopStart: w.startDateTime,
                            workshopEnd: w.endDateTime,
                            workshopLocation: w.location,
                            reminderTime: reminderTime.toISOString(),
                            reminderMinutes: mins,
                            status: 'pending'
                        });
                    }
                });
            });
            if (schedules.length === 0) { showToast('â„¹ï¸ ç„¡éœ€å»ºç«‹æé†’æ’ç¨‹', 'info'); return; }
            fetch(gasUrl, {
                method: 'POST', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'createSchedules', secret: gasSecret, token: token, userId: userId, schedules: schedules })
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.success) {
                    showToast('ğŸ”” å·²å»ºç«‹ ' + schedules.length + ' å€‹æé†’æ’ç¨‹ï¼', 'success');
                    document.getElementById('scheduleCount').textContent = schedules.length;
                } else { console.error('æ’ç¨‹å»ºç«‹å¤±æ•—:', result.error); }
            }).catch(function(err) { console.error('æ’ç¨‹å»ºç«‹éŒ¯èª¤:', err); });
        }

        function loadScheduleList() {
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();
            if (!gasUrl || !gasSecret) { document.getElementById('scheduleListCard').style.display = 'none'; return; }
            fetch(gasUrl + '?action=getSchedules&secret=' + encodeURIComponent(gasSecret))
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (result.success && result.schedules) {
                    var schedules = result.schedules;
                    document.getElementById('scheduleCount').textContent = schedules.length;
                    if (schedules.length > 0) {
                        document.getElementById('scheduleListCard').style.display = 'block';
                        document.getElementById('scheduleListCount').textContent = schedules.length + ' å€‹æ’ç¨‹';
                        var html = '';
                        schedules.sort(function(a,b) { return new Date(a.reminderTime) - new Date(b.reminderTime); });
                        schedules.forEach(function(s) {
                            var rt = new Date(s.reminderTime);
                            var isPast = rt < new Date();
                            var statusClass = s.status === 'sent' ? 'sent' : 'pending';
                            var statusText = s.status === 'sent' ? 'å·²ç™¼é€' : (isPast ? 'å¾…ç™¼é€' : 'æ’ç¨‹ä¸­');
                            html += '<div class="schedule-item"><div class="schedule-title">' + s.workshopTitle + '</div>';
                            html += '<div class="schedule-time">ğŸ”” ' + formatDate(rt) + ' ' + formatTime(rt) + '</div>';
                            html += '<div class="schedule-status ' + statusClass + '">' + statusText + '</div></div>';
                        });
                        document.getElementById('scheduleList').innerHTML = html;
                    } else { document.getElementById('scheduleListCard').style.display = 'none'; }
                }
            }).catch(function(err) { console.error('è¼‰å…¥æ’ç¨‹å¤±æ•—:', err); });
        }

        function clearAllReminders() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰æ’ç¨‹å—ï¼Ÿ')) return;
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();
            if (!gasUrl || !gasSecret) { showToast('âš ï¸ è«‹å…ˆè¨­å®š GAS', 'error'); return; }
            showToast('ğŸ—‘ï¸ æ­£åœ¨æ¸…é™¤...', 'info');
            fetch(gasUrl, {
                method: 'POST', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({ action: 'clearSchedules', secret: gasSecret })
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.success) {
                    showToast('âœ… å·²æ¸…é™¤æ‰€æœ‰æ’ç¨‹', 'success');
                    document.getElementById('scheduleCount').textContent = '0';
                    document.getElementById('scheduleListCard').style.display = 'none';
                } else { showToast('âŒ æ¸…é™¤å¤±æ•—', 'error'); }
            }).catch(function(err) { showToast('âŒ ' + err.message, 'error'); });
        }

        function testLineNotification() {
            var token = document.getElementById('lineChannelAccessToken').value.trim();
            var userId = document.getElementById('lineUserId').value.trim();
            var gasUrl = document.getElementById('gasWebAppUrl').value.trim();
            var gasSecret = document.getElementById('gasSecretKey').value.trim();
            if (!token || !userId || !gasUrl || !gasSecret) { showToast('âš ï¸ è«‹å¡«å¯«å®Œæ•´è¨­å®š', 'error'); return; }
            showToast('ğŸ“¨ ç™¼é€æ¸¬è©¦ä¸­...', 'info');
            var tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1); tomorrow.setHours(9, 0, 0, 0);
            fetch(gasUrl, {
                method: 'POST', headers: { 'Content-Type': 'text/plain' },
                body: JSON.stringify({
                    secret: gasSecret, token: token, userId: userId,
                    workshops: [{ title: 'ğŸ“š æ¸¬è©¦ç ”ç¿’é€šçŸ¥', startDateTime: tomorrow.toISOString(), endDateTime: new Date(tomorrow.getTime() + 3*60*60*1000).toISOString(), location: 'æ¸¬è©¦åœ°é»', description: 'é€™æ˜¯æ¸¬è©¦è¨Šæ¯' }]
                })
            }).then(function(r) { return r.json(); }).then(function(result) {
                if (result.success) showToast('âœ… æ¸¬è©¦è¨Šæ¯å·²ç™¼é€ï¼', 'success');
                else showToast('âŒ ' + (result.error || 'å¤±æ•—'), 'error');
            }).catch(function(err) { showToast('âŒ ' + err.message, 'error'); });
        }

        function updateLineStatus() {
            var t = document.getElementById('lineChannelAccessToken').value.trim();
            var u = document.getElementById('lineUserId').value.trim();
            var g = document.getElementById('gasWebAppUrl').value.trim();
            var s = document.getElementById('gasSecretKey').value.trim();
            updateSt('token', t); updateSt('userId', u); updateSt('gas', g); updateSt('secret', s);
        }

        function updateSt(n, v) {
            document.getElementById(n + 'Status').textContent = v ? 'å·²è¨­å®š (' + v.substring(0, 8) + '...)' : 'æœªè¨­å®š';
            document.getElementById(n + 'Icon').textContent = v ? 'âœ…' : 'âŒ';
        }

        function toggleLocalStorage() {
            var toggle = document.getElementById('localStorageToggle');
            if (toggle.classList.contains('active')) {
                if (confirm('ç¢ºå®šåœç”¨ï¼Ÿ')) { toggle.classList.remove('active'); localStorageEnabled = false; localStorage.removeItem(STORAGE_PREFIX + 'enabled'); showToast('âœ… å·²åœç”¨', 'success'); }
            } else {
                if (confirm('å•Ÿç”¨æœ¬æ©Ÿå„²å­˜ï¼Ÿ')) { toggle.classList.add('active'); localStorageEnabled = true; localStorage.setItem(STORAGE_PREFIX + 'enabled', 'true'); saveSettings(); showToast('âœ… å·²å•Ÿç”¨', 'success'); }
            }
        }

        function saveSettings() {
            if (!localStorageEnabled) return;
            try {
                localStorage.setItem(STORAGE_PREFIX + 'geminiApiKey', document.getElementById('geminiApiKey').value);
                localStorage.setItem(STORAGE_PREFIX + 'googleClientId', document.getElementById('googleClientId').value);
                localStorage.setItem(STORAGE_PREFIX + 'lineToken', document.getElementById('lineChannelAccessToken').value);
                localStorage.setItem(STORAGE_PREFIX + 'lineUserId', document.getElementById('lineUserId').value);
                localStorage.setItem(STORAGE_PREFIX + 'gasUrl', document.getElementById('gasWebAppUrl').value);
                localStorage.setItem(STORAGE_PREFIX + 'gasSecret', document.getElementById('gasSecretKey').value);
            } catch (e) {}
        }

        function loadSettings() {
            try {
                if (localStorage.getItem(STORAGE_PREFIX + 'enabled') === 'true') {
                    localStorageEnabled = true;
                    document.getElementById('localStorageToggle').classList.add('active');
                    var gk = localStorage.getItem(STORAGE_PREFIX + 'geminiApiKey');
                    var gc = localStorage.getItem(STORAGE_PREFIX + 'googleClientId');
                    var lt = localStorage.getItem(STORAGE_PREFIX + 'lineToken');
                    var lu = localStorage.getItem(STORAGE_PREFIX + 'lineUserId');
                    var gu = localStorage.getItem(STORAGE_PREFIX + 'gasUrl');
                    var gs = localStorage.getItem(STORAGE_PREFIX + 'gasSecret');
                    if (gk) document.getElementById('geminiApiKey').value = gk;
                    if (gc) document.getElementById('googleClientId').value = gc;
                    if (lt) document.getElementById('lineChannelAccessToken').value = lt;
                    if (lu) document.getElementById('lineUserId').value = lu;
                    if (gu) document.getElementById('gasWebAppUrl').value = gu;
                    if (gs) document.getElementById('gasSecretKey').value = gs;
                }
            } catch (e) {}
        }

        function clearAllData() {
            if (!confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ')) return;
            try { Object.keys(localStorage).forEach(function(k) { if (k.startsWith(STORAGE_PREFIX)) localStorage.removeItem(k); }); } catch (e) {}
            document.getElementById('geminiApiKey').value = '';
            document.getElementById('googleClientId').value = '';
            document.getElementById('lineChannelAccessToken').value = '';
            document.getElementById('lineUserId').value = '';
            document.getElementById('gasWebAppUrl').value = '';
            document.getElementById('gasSecretKey').value = '';
            document.getElementById('scheduleText').value = '';
            document.getElementById('localStorageToggle').classList.remove('active');
            document.getElementById('authStatus').innerHTML = '';
            localStorageEnabled = false;
            parsedEvents = [];
            document.getElementById('eventsPreview').innerHTML = '';
            document.getElementById('eventsPreview').style.display = 'none';
            document.getElementById('importActions').style.display = 'none';
            document.getElementById('eventCount').textContent = '0';
            document.getElementById('scheduleCount').textContent = '0';
            showToast('âœ… å·²æ¸…é™¤', 'success');
        }

        document.querySelectorAll('.input-field').forEach(function(i) { i.addEventListener('change', function() { if (localStorageEnabled) saveSettings(); }); });
    </script>
</body>
</html>
